name: Deploy Versioned Docs

on:
  push:
    branches: [ main, develop, "release/*" ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout current branch
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: latest

    - name: Install dependencies
      run: pnpm install

    - name: Get branch name
      id: branch
      run: echo "name=${GITHUB_REF#refs/heads/}" >> $GITHUB_OUTPUT

    - name: Download existing GitHub Pages (to preserve other versions)
      continue-on-error: true
      run: |
        # Try to download existing gh-pages content
        git fetch origin gh-pages:gh-pages 2>/dev/null || echo "No existing gh-pages branch"
        if git branch | grep -q gh-pages; then
          git checkout gh-pages
          cp -r . ../existing-pages/ 2>/dev/null || mkdir -p ../existing-pages
          git checkout ${{ steps.branch.outputs.name }}

          # Copy existing versions to preserve them
          if [ -d "../existing-pages" ]; then
            mkdir -p dist-versioned
            cp -r ../existing-pages/* dist-versioned/ 2>/dev/null || echo "No existing content to preserve"
            # Remove git files from copied content
            rm -rf dist-versioned/.git* 2>/dev/null || true
          fi
        else
          echo "Creating new gh-pages deployment"
          mkdir -p dist-versioned
        fi

    - name: Build versioned docs
      env:
        BRANCH_NAME: ${{ steps.branch.outputs.name }}
      run: pnpm run build:versioned

    - name: Create version selector (optional)
      run: |
        cat > dist-versioned/versions.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
          <title>Solop Docs - Version Selector</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 40px; }
            h1 { color: #333; }
            ul { list-style-type: none; padding: 0; }
            li { margin: 10px 0; }
            a { text-decoration: none; color: #007acc; font-size: 18px; }
            a:hover { text-decoration: underline; }
          </style>
        </head>
        <body>
          <h1>Solop Documentation Versions</h1>
          <ul>
            <li><a href="/">ðŸ“š Latest (Main)</a></li>
        EOF

        # Add other versions if they exist
        if [ -f dist-versioned/versions.json ]; then
          node -e "
            const versions = JSON.parse(require('fs').readFileSync('dist-versioned/versions.json', 'utf8'));
            versions.filter(v => v !== 'main').forEach(v => {
              console.log(\`            <li><a href=\"/\${v}/\">ðŸ”– \${v}</a></li>\`);
            });
          " >> dist-versioned/versions.html
        fi

        cat >> dist-versioned/versions.html << 'EOF'
          </ul>
        </body>
        </html>
        EOF

    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./dist-versioned
        keep_files: false
        force_orphan: false